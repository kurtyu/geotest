<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=520; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
    <style type="text/css">

        /* Remove margins and HTML scrollbars */
        BODY, HTML  {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>  

	<title>究心公益科技：遊戲</title>

    <!-- 風格 -->
	<link href="GameStyles.css" rel="stylesheet" type="text/css"/>

    <!-- CreateJS -->
	 <script type="text/javascript" src="https://code.createjs.com/createjs-2015.11.26.min.js"></script>

    <!-- Tween -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.1/TweenLite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.1/plugins/EaselPlugin.min.js"></script>

    <!-- 簡單的後台 -->
    <script type="text/javascript" src="https://parse.com/downloads/javascript/parse-1.6.12.min.js"></script>

    <script src="OrangeTween.js"></script>  
    <script src="QuestionBoard.js"></script>
    <script src="Puzzle.js"></script>  
    <script src="Resource.js"></script>      
    <script src="MainStage.js"></script>

	<script>
        var screenWidth = 520;
        var screenHeight = 640;

        // 舞台
        var stage;

        // 玩家數值
        // 下注單位
        var g_nBet = 0;
        // 下注線(PayLines)
        var g_nPayLines = 0;
    
 
        // 載入物件
        // var loadingImg;
        var loaderBar;
        var barShape; 
        var bar;   
        var barWidth;   

        // 背景顏色
        // var bg;

        // 遊戲大廳
        // var lobbyContainer;
        // 遊戲畫面
        var mGameContainer;
    
        // 贏錢線
        // var g_PayLines;

        // 玩家姓名
        var mUserName;

        // 資源
        var assets;
        // 圖示資源(1~9)(10:WILD)(11:BONUS)(12:SCATTER)
        var iconAssets;

        // 排行榜按鈕
        var mRankButton;
        var mRankBoard;
        var mRanksArray;
        var mCloseButton;


        // 遊戲分數
        var mGameScoreBorder;
        var mGameScore;

        // 遊戲時間
        var mGameTimerBorder;
        var mGameTimer;

        // 地圖背景圖
        var puzzle03Bitmap;

        var puzzleLine4x4Bitmap;

        // 玩家陣列
        var role;

        // var myPuzzleContainer;

        // 地圖容器
        var mapContainer;

        // 拼圖容器(頂層)
        var blackPuzzleContainer;

        var mSoundClick;
        var mSoundBackground;

        // 拼圖容器(底層)
        // var bottomPuzzleContainer;

        // 更新位置
        // var captureButton;

        // 玩家名稱
        var username;

        // 目前的拼圖塊容器
        var currentPuzzleContainer;


        // 問題
        var question;

        // 拼圖資源
        var mPuzzleArray;

        var mNormalPuzzleArray;
        var mBlackPuzzleArray;

        // 問題容器
        var mQuestionBoard;
        
        // var questonContainer;
        // 文字
        var questionText;
        // 圖片
        var questionImage;
        // 答案A
        var aAnswerButton;
        // 答案B
        var bAnswerButton;
        // 答案C
        var cAnswerButton;



        // 分數效果容器
        // var mScoreContainer;
        // var mScoreArray;
        var mGoodEffect;
        // var mNoEffect;
        var mSpeedUpEffect;

        var mLifeArray;
        var mLife;

        var mCorrectCount;
        // 正確回答次數
        var mCorrectAnswerCount;

        // 拼圖掉落次數
        var mDropPuzzleCount;
        // 拼圖掉落等級
        var mPuzzleLevel;

        // 開始按鈕
        var mStartButton;

        // 標題
        var mTitle;
        // 副標題
        var mSubTitle;

        // 問題20
        var mQuestion20;
        // 時間100
        var mTime100;  
        // 究心公益開發
        var mGeothings;      

        // 目前的拼圖塊
        var mTargetPuzzle;

        // 目前進度數字
        var mProgress; 

        // 禁止連續點擊
        var mTouchLock;

        // 旋轉速度
        var mSpeedLevel;

        // 進入遊戲按鈕
        var mStartGameButton;

        //  橘子弟
        var mOrange;

        // 遊戲說明
        var mHelp;
        // 遊戲說明時間限制
        var mHelpTimeLimit;
        // 遊戲規則說明標題
        var mGameRuleTitle;

        var mBlackShape;

        var mGameResultScoreBorder;
        var mGameResultScore;

        var mGameResultTimeBorder;
        var mGameResultTime;

        var mGameAgainButton;


        // Parse
        var mGameRecord;

        window.onload = function () 
        {
            console.log("init");
            init();
        };

        //  註冊畫面大小改變
        window.addEventListener('resize', resize, false);
        function resize()
        {
            // 螢幕寬高
            stage.canvas.width = window.innerWidth;                  
            stage.canvas.height = window.innerHeight; 

            // if(stage.canvas.width < screenWidth)
            // {
            //     var rate = stage.canvas.height / screenHeight;
            //     stage.canvas.width = screenWidth * rate;
            //     stage.scaleY = stage.canvas.height / screenHeight;
            //     stage.scaleX = stage.scaleY; 
            //     // 修改之後發現超過了 再退回去
            //     if(stage.canvas.width > screenWidth)
            //     {
            //         var rate = stage.canvas.width / screenWidth;
            //         stage.canvas.height = screenHeight * rate;
            //         stage.scaleX = stage.canvas.width / screenWidth;
            //         stage.scaleY = stage.scaleX; 
            //     }
            // }
            // else
            // {
            //     var rate = stage.canvas.width / screenWidth;
            //     stage.canvas.height = screenHeight * rate;
            //     stage.scaleX = stage.canvas.width / screenWidth;
            //     stage.scaleY = stage.scaleX; 
            //     // 修改之後發現超過了 再退回去
            //     if(stage.canvas.height > screenHeight)
            //     {
            //         var rate = stage.canvas.height / screenHeight;
            //         stage.canvas.width = screenWidth * rate;
            //         stage.scaleY = stage.canvas.height / screenHeight;
            //         stage.scaleX = stage.scaleY; 
            //     }
            // }


            if(mGameContainer != null)
            {
                stage.x = window.innerWidth/2 - screenWidth/2;
            }

            // stage.x = (window.innerWidth - stage.canvas.width)/2;

            console.log("螢幕大小改變");       
        }

    	function init() 
        {
            // var screenOrientationPromise = screen.orientation.lock('portrait-primary');

            Parse.initialize("tJuiEhLCYFqRyqCi7wgJ8046FUPCh8yIq3TSAfoz", "6xJDfskgg4T9knFTcrEfe4dMfbzvpfI5HzsxluC4");
    
            mUserName = getUserName();
            console.log("玩家名稱:"+mUserName);
            parseUserInit("kurtyu", "0000");
            
            mCorrectCount = 0;

            mDropPuzzleCount = 0;

            mPuzzleLevel = 0;

            // Image陣列物件
            assets = [];
            iconAssets = [];

            // 目前拼圖
            mPuzzleArray = [];
            // 黑色拼圖
            mBlackPuzzleArray = [];

            mNormalPuzzleArray = [];

            // 分數效果容器
            mScooreArray = [];

            // 生命
            // mLifeArray = [];

            // 排行榜分數
            mRanksArray = [];


    		// Stage物件：Display List 最底層的物件
    		var canvas = document.getElementById("GameCanvas");

    		stage = new createjs.Stage(canvas); 
            // stageWidth = stage.canvas.width;
            // stageHeight = stage.canvas.height;        

  

            // 經典的你好世界
    		// var text = new createjs.Text("Hello World!", "36px Arial", "#777");
    		// stage.addChild(text);

            // 讀取進度條
            // =================================================================
            barWidth = 300;
            var barHeight = 20;
            // 外框距離
            var padding = 3;      

            // getRGB() 回傳字串  EX: "rgb(255, 255, 255)"        
            var loaderColor = createjs.Graphics.getRGB(247,247,247);

            // 畫框線
            bar = new createjs.Shape();
            bar.graphics.beginFill(loaderColor).drawRect(0, 0, 1, 20).endFill();        

            // 填滿顏色
            var bgBar = new createjs.Shape();
            bgBar.graphics.setStrokeStyle(1).beginStroke(loaderColor).drawRect(-padding/2, -padding/2, barWidth+padding, barHeight+padding);        

            loaderBar = new createjs.Container();
            loaderBar.x = (window.innerWidth - barWidth)>>1;
            loaderBar.y = (window.innerHeight - barHeight)>>1; 
            loaderBar.addChild(bar, bgBar);     
            // loaderBar.visible = false;

            stage.addChild(loaderBar);
            // =================================================================

            resize();
            // 開始讀取
            startLoading();       
            
            TweenLite.ticker.addEventListener("tick", tickFunction, stage);
    	}

        function mouseDownHandler(event)
        {
           console.log(nameInput.value);
        }

        function tickFunction() 
        {
            // if(!createjs.Ticker.getPaused())
            // {
                stage.update();
                // console.log("update");
            // }

            rollContainer(mapContainer, 0.05);

            switch(mSpeedLevel)
            {
                case 1:
                    rollContainer(blackPuzzleContainer, -0.15);
                    break;
                case 2:
                    rollContainer(blackPuzzleContainer, 0.15);
                    break;
                case 3:
                    rollContainer(blackPuzzleContainer, -0.2);
                    break;                
                case 4:
                    rollContainer(blackPuzzleContainer, 0.25);
                    break;                
                case 5:
                    rollContainer(blackPuzzleContainer, -0.3);
                    break;   
                case 6:
                    rollContainer(blackPuzzleContainer, 0.35);
                    break;  
                case 7:
                    rollContainer(blackPuzzleContainer, -0.4);
                    break;   
                case 8:
                    rollContainer(blackPuzzleContainer, 0.45);
                    break;  
                case 9:        
                    rollContainer(blackPuzzleContainer, -0.5);
                    break;  
            }
            
            rollContainer(currentPuzzleContainer, 0.15);
        } 

        function rollContainer(container, speed)
        {
            if(container != null)
            {    
                container.rotation +=speed;
                if(container.rotation>=360)
                {
                    container.rotation=0; 
                }
            }
        }

        function showBlackPuzzle()
        {
            // var i = 0;
            // for(i=0; i<mBlackPuzzleArray; i++)
            // {
            //     TweenLite.to(puzzleArray[i], 1, 
            //     {
            //         repeat:-1,
            //         rotation:360,
            //         transformOrigin:"50% 50%"
            //     });
            // }
                // TweenLite
                // .to(role, 1, 
                // {
                //     repeat:-1,
                //     rotation:360,
                //     transformOrigin:"50% 50%"
                // });

            // TweenLite.to
            // (role, 1, {delay:1.0, 
            //             scaleX:1.5, scaleY:0.8, x:250, y:150, rotation:180,
            //             onComplete:handleStartGame});

            dropObject(mBlackPuzzleArray[0], 100, null);
            dropObject(mBlackPuzzleArray[2], 200, null);
            dropObject(mBlackPuzzleArray[4], 300, null);
            dropObject(mBlackPuzzleArray[6], 300, null);

                // TweenLite.to(captureButton, 2, {scaleX:.5, scaleY:.5, easel:{tint:0x00FF00}});
        }

        function startGame()
        {
            console.log("遊戲開始");
            // 玩家生命
            // mLife = 3;



            // 顯示紅色愛心（隱藏灰色）
            // dropObject(mLifeArray[0], 0);
            // dropObject(mLifeArray[1], 100);
            // dropObject(mLifeArray[2], 200);
            // mLifeArray[3].visible = false;
            // mLifeArray[4].visible = false;
            // mLifeArray[5].visible = false; 

            mGameTimer.text = 99;
            mGameTimerBorder.text = 99;

            // 拼圖正確數
            mCorrectCount = 0;
            // 拼圖掉落次數
            mDropPuzzleCount = 0;
            // 拼圖掉落等級
            mPuzzleLevel = 0;

            // 正確答題數
            mCorrectAnswerCount = 0;

            // 旋轉速度
            mSpeedLevel = 1;

            mTargetPuzzle = null;

            hideObject(mTitle);
            hideObject(mSubTitle);
            hideObject(mTime100);
            hideObject(mQuestion20);

            hideObject(mRankButton);

            nextGameStep(0);

            // 顯示遊戲時間     
            mGameTimerBorder.visible = true;
            mGameTimer.visible = true;

            mGameScoreBorder.visible = true;
            mGameScore.visible = true;

            // 彈出遊戲規則說明（從標題開始）
            mBlackShape.visible = true;
            dropUpObject(mGameRuleTitle, showRule);

            // mQuestionBoard.dropQuestion();
        }        

        function showRankList()
        {
            parseGetGameRecordList();

            mRankBoard.visible = true;
            for(var k=0; k<mRanksArray.length; k++)
            {
                mRanksArray[k].visible = true;
            }

            hideObject(mTime100);
            hideObject(mQuestion20);
            
        }

        // 遊戲繼續進行
        function nextGameStep(result)
        {
            if(mOrange.visible == true)
            {
                return;
            }
            // result
            // -1 錯誤選擇拼圖
            // 1 正確選擇拼圖
            // -2 錯誤選擇答案
            // 2 正確選擇答案            
            // 0 初始化

            // 正確選擇拼圖 or 正確選擇答案
            if(result == 1 || result == 2)
            {
                mCorrectCount++;

                switch(mCorrectCount)
                {
                    case 2:
                    case 4:
                    case 6:
                    case 8:
                    case 10:
                    case 12:
                    case 14:
                    case 16:
                    case 18:
                    case 20:
                    case 22:
                    case 24:
                    case 26:
                    case 28:
                    case 30:
                    case 32:
                    case 34:
                    case 36:
                    case 38:
                    case 40:
                        stopGameTimer();
                        mQuestionBoard.dropQuestion();
                        updateGameScore();
                        mTouchLock = true;
                        break;
                    default:
                        dropCurrentPuzzle();  
                        break;
                }

                if(result == 2)
                {
                    mCorrectAnswerCount++;

                    mQuestionBoard.hideQuestion();
                    dropBlackPuzzle(3);

                    zoomInObject(mSpeedUpEffect, 1000, 1.8);

                    mSpeedLevel++;
                    if(mSpeedLevel>=9)
                    {
                        mSpeedLevel = 9;
                    }

                    mTouchLock = false;
                    startGameTimer();
                }

                console.log("正確數:"+mCorrectCount);

                // mGameScore.text = mCorrectCount+"/100";
            }
            // 錯誤選擇答案
            else if(result == -2)
            {
                mQuestionBoard.hideQuestion();
                dropBlackPuzzle(3);
                dropCurrentPuzzle();

                mTouchLock = false;
                startGameTimer();
            }
            // 初始化
            else if(result == 0)
            {
                dropBlackPuzzle(5);
                dropCurrentPuzzle();
                // 隨機
                mQuestionBoard.shuffle();
            }

            if((mCorrectCount%3)==0)
            {
                console.log("隱藏全部的拼圖:"+mCorrectCount);
                hideAllFlipPuzzle();
            }


            // 遊戲結束(達成問題回答數)
            if(mQuestionBoard.mQuestionIndex >= 100)
            {
                // 遊戲結束
                stopGameTimer();
                var time = formatFloat((mGameTimer.text - 0.1), 2);
                showGameOver(mCorrectAnswerCount, time); 
            }             
        }

        function updateGameScore()
        {
            mQuestionBoard.mQuestionIndex++;
            mGameScore.text = mQuestionBoard.mQuestionIndex+"/20題";
            mGameScoreBorder.text = mGameScore.text;
        }

        function flipPuzzle(puzzleId)
        {
            console.log("puzzleId = "+puzzleId);
            var normalPuzzle = getNormalPuzzle(puzzleId);  
            normalPuzzle.visible = true;
            normalPuzzle.scaleX = 1;
            normalPuzzle.scaleY = 1;
            normalPuzzle.alpha = 1;

            var blackPuzzle = getBlackPuzzle(puzzleId);
            blackPuzzle.mType = 1;  
            blackPuzzle.scaleX = 1;
            blackPuzzle.scaleY = 1;
            blackPuzzle.alpha = 1;

            disappearObject(blackPuzzle, checkFlipPuzzle, 
                normalPuzzle, blackPuzzle);
        }        

        function checkFlipPuzzle(normalPuzzle, blackPuzzle)
        {
            console.log("測試："+normalPuzzle.mPuzzleId);
            if(normalPuzzle.mPuzzleId == mTargetPuzzle.mPuzzleId)
            {
                // 答對啦
                console.log("答對啦");
                // rubberband(mGoodEffect);

                zoomInObject(mGoodEffect, 0, 1.6);
                // mGoodEffect.visible = true;
                zoomInObject(mTargetPuzzle, 0, 1.2, rightPuzzleAnswer, blackPuzzle);
                // disappearObject(normalPuzzle, rightAnswer, normalPuzzle, blackPuzzle);
            }
            else
            {
                // 翻回去
                console.log("翻回去:"+normalPuzzle.rotation);
                appearObject(blackPuzzle, flipBack, normalPuzzle);

                // mNoEffect.rotation = normalPuzzle.rotation;
                // mNoEffect.regX = normalPuzzle.regX;
                // mNoEffect.regY = normalPuzzle.regY;
                // rubberband(mNoEffect);
            }
        }

        function rightPuzzleAnswer(blackPuzzle)
        {
            blackPuzzle.mDrop = false;
            mTouchLock = false;
            nextGameStep(1);
        }

        function flipBack(normalPuzzle)
        {
            normalPuzzle.visible = false;
            mTouchLock = false;
        }

        function hideAllFlipPuzzle()
        {
            console.log("hideAllFlipPuzzle");

            for(var i=0; i<mNormalPuzzleArray.length; i++)
            {
                var puzzle = mNormalPuzzleArray[i];
                if(puzzle.visible)
                {
                    disappearObject(puzzle);

                    var blackPuzzle = getBlackPuzzle(puzzle.mPuzzleId);
                    blackPuzzle.visible = false;
                    blackPuzzle.mType = 1;  
                }
            }

            // createjs.Tween.removeTweens(object);

            // console.log("mCurrentPuzzle:"+mCurrentPuzzle);
            // hideObject(getNormalPuzzle[mCurrentPuzzle.mPuzzleId]);
            // object.visible = false;
            // var blackPuzzle = getBlackPuzzle(object.mPuzzleId);
            // blackPuzzle.visible = false;
            // blackPuzzle.mType = 0;

            // nextGameStep(1);
        }

        // 丟入目前的拼圖塊
        function dropTargetPuzzle(puzzleId)
        {
            console.log("丟拼圖塊:"+puzzleId);
            
            var i = 0;
            for(i = 0 ; i<mPuzzleArray.length; i++)
            {
                var puzzle = mPuzzleArray[i];
                if(puzzle.mPuzzleId == puzzleId)
                {
                    mTargetPuzzle = puzzle;
                    dropObject(puzzle, 0, startPuzzleTicker(puzzle));
                    break;
                }
            }
        }

        // 丟入目前黑色拼圖的目標彩色拼圖
        function dropCurrentPuzzle()
        {
            var randomIndex = Math.floor(Math.random() * (mBlackPuzzleArray.length-1));
            for(var i=0; i<mBlackPuzzleArray.length; i++)
            {
                var puzzle = mBlackPuzzleArray[mPuzzleIndex[randomIndex]];
                if(puzzle.mDrop == true)
                {
                    dropTargetPuzzle(puzzle.mPuzzleId);                    
                    break;
                }
                randomIndex++;
                if(randomIndex == mBlackPuzzleArray.length)
                {
                    randomIndex = 0;
                }
            }
        }        

        function startPuzzleTicker(object)
        {
            // mCurrentPuzzle = object;
        }

        // 丟入指定數量的黑色拼圖
        function dropBlackPuzzle(number)
        {
            // number 丟的數量
            // 找到位置丟入 Math.random() = 0.0~1.0

            shufflePuzzleIndex();

            var findCount = 0;
            for(var i=0; i<mBlackPuzzleArray.length; i++)
            {
                var puzzle = mBlackPuzzleArray[mPuzzleIndex[i]];
                var normalPuzzle =  getNormalPuzzle(puzzle.mPuzzleId);
                if((puzzle.mDrop == false) && (normalPuzzle.visible == false))
                {
                    // 丟入拼圖
                    dropObject(puzzle, 100*number);
                    puzzle.mDrop = true;
                    number--;
                }
                findCount++;

                // 數量找齊了
                if(number == 0)
                {
                    break;
                }
            }
        }

        var mPuzzleIndex = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15];
        function shufflePuzzleIndex() 
        {
            var currentIndex = mPuzzleIndex.length;
            var temporaryValue;
            var randomIndex;

            // While there remain elements to shuffle...
            while (0 !== currentIndex) 
            {
                // Pick a remaining element...
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex -= 1;

                // And swap it with the current element.
                temporaryValue = mPuzzleIndex[currentIndex];
                mPuzzleIndex[currentIndex] = mPuzzleIndex[randomIndex];
                mPuzzleIndex[randomIndex] = temporaryValue;
            }
        }        

        function showRule()
        {
            appearObject(mHelp);
            appearObject(mHelpTimeLimit);
            mStartGameButton.visible = true;
        }

        function startGameTimer()
        {
            console.log("遊戲開始");
            createjs.Tween.get(mGameTimer, {loop: true}) 
            .wait(100)
            .call(updateGameTimer);
        }

        function stopGameTimer()
        {
            createjs.Tween.removeTweens(mGameTimer);
        }

        function updateGameTimer()
        {
            var time = formatFloat((mGameTimer.text - 0.1), 2);
 
            // 遊戲結束(達成問題回答數)
            if(time <= 0)
            {
                // 遊戲結束
                time = 0;
                stopGameTimer();
                console.log("遊戲結束");

                showGameOver(mCorrectAnswerCount, time);
            }

            mGameTimer.text = time;
            mGameTimerBorder.text = time;      
        }        

        function showGameOver(score, time)
        {
            mGameTimerBorder.visible = false;
            mGameTimer.visible = false;

            // 黑色背景
            mBlackShape.visible = true;
            mBlackShape.alpha = 0.5;

            var rate = formatFloat((mQuestionBoard.mQuestionIndex/20*100),1);
            mGameResultScoreBorder.text = "答題率"+rate+"%\n正確 "+score+"題";
            mGameResultScore.text = mGameResultScoreBorder.text;

            // 儲存遊戲分數
            saveGameRecord(mUserName, score, rate);

            mGameResultTimeBorder.text = "剩餘時間 "+time+"秒";
            mGameResultTime.text = mGameResultTimeBorder.text;

            dropObject(mGameResultScoreBorder, 100);
            dropObject(mGameResultScore, 100);

            dropObject(mGameResultTimeBorder, 200);
            dropObject(mGameResultTime, 200); 

            dropObject(mOrange); 

            dropObject(mGameAgainButton);
        }
        //each time the tween updates this function will be called.
        // function showTime() 
        // {
        //     gameTimer.text = gameTimer.score.toFixed(2);
        // }

        function getUserName()
        {
            var parameters = location.search.substring(1).split("&");
            if(parameters.length == 0)
            {
                return "路人";
            }
            else
            {
                var temp = parameters[0].split("=");
                if(temp.length == 0)
                {
                    return "路人";
                }
                else
                {
                    return unescape(temp[1]);
                }
            }
        }

        // 初始化使用者
        function parseUserInit(username, password)
        {
            var currentUser = Parse.User.current();
            if (currentUser) 
            {
                // do stuff with the user
            } 
            else 
            {
                // show the signup or login page
                // 嘗試去登入
                var result = parseLogin(username, password);
                if(result == true)
                {

                }
                else
                {
                    // 嘗試去註冊
                    parseSignup(username, password);
                }
            }
        }

        // 登入
        function parseLogin(username, password)
        {
            console.log("登入玩家");
            Parse.User.logIn(username, password, {
                success: function(user) 
                {
                // Do stuff after successful login.
                    return true;
                },
                error: function(user, error) 
                {
                // The login failed. Check error to see why.
                    return false;
                }
            });
        }

        // 登出
        function parseLogout()
        {
            Parse.User.logOut();
            // var currentUser = Parse.User.current();  // this will now be null
        }

        function parseSignup(username, password)
        { 
            console.log("註冊玩家");
            // 
            var user = new Parse.User();
            user.set("username", username);
            user.set("password", password);
            user.set("email", "email@example.com");
            user.signUp(null, 
            {
                success: function(user) 
                {
                    console.log("註冊玩家成功");
                },
                error: function(user, error) 
                {
                    // 已經註冊過了
                    // alert("Error: " + error.code + " " + error.message);
                    console.log("註冊玩家失敗");
                }
            });
        }    

        function parseGetGameRecordList()
        {
            var object = Parse.Object.extend("GameRecord");
            var query = new Parse.Query(object);
            query.descending("score");
            query.limit(10);
            query.find(
            {
                success: function(result) 
                {
                    // alert("Successfully retrieved " + result.length + " scores.");

                    if(result != null)
                    {
                        // 顯示前10名就好
                        for(var j=0; j<result.length; j++)
                        {
                            console.log(result[j].get("score")+" = "+result[j].get("rate"));

                            if((j+1)<10)
                            {
                                rankNumber = "0"+(j+1);
                            }
                            else
                            {
                                rankNumber = (j+1);
                            }
                            var rank = mRanksArray[j];
                            rank.text = rankNumber+":"+result[j].get("playername")+
                            "("+result[j].get("score")+"題/"+result[j].get("rate")+"%)"; 
                        }
                    }

                    
                },
                error: function(error)
                {
                    // alert("Error: " + error.code + " " + error.message);
                    return null;
                }
            });
        }

        function saveGameRecord(username, score, rate)
        {
            var parseObject = getUserGameRecord(username);
            if(parseObject == null)
            {
                parseObject = createGameRecord(username);
            }
            parseObject.set("playername", ""+username);
            parseObject.set("score", score);
            parseObject.set("rate", rate);
            parseObject.save(null, 
            {
              success: function(gameScore) 
              {
                // Execute any logic that should take place after the object is saved.
                // alert('New object created with objectId: ' + gameScore.id);
              },
              error: function(gameScore, error) 
              {
                // Execute any logic that should take place if the save fails.
                // error is a Parse.Error with an error code and message.
                // alert('Failed to create new object, with error code: ' + error.message);
              }
            });
        }

        function createGameRecord(usernamem)
        {
            // 建立遊戲紀錄
            var GameRecordObject = Parse.Object.extend("GameRecord");
            var parseObject = new GameRecordObject();
            parseObject.set("playername", username);
            parseObject.save(null, 
            {
                success: function(object) 
                {
                },
                error: function(model, error) 
                {
                }
            });
            return parseObject;
        }  

        function getUserGameRecord(username)
        {
            var GameRecordObject = Parse.Object.extend("GameRecord");
            var query = new Parse.Query(GameRecordObject);
            query.equalTo('playername', username);
            query.first(
            {
                success: function(result) 
                {
                    return result;
                },
                error: function(error)
                {
                    return null;
                }
            });
        }

	</script>
</head>
	
<body>
    <div id="map"></div>
    <div class="canvasHolder">
        <canvas id="GameCanvas" width="480" height="640"></canvas> 
    </div>
</body>

</html>
