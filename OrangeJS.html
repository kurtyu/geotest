<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=320; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
    <style type="text/css">

        /* Remove margins and HTML scrollbars */
        BODY, HTML  {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>  

	<title>究心公益科技：遊戲</title>

    <!-- 風格 -->
	<link href="GameStyles.css" rel="stylesheet" type="text/css"/>

    <!-- CreateJS -->
	 <script type="text/javascript" src="https://code.createjs.com/createjs-2015.11.26.min.js"></script>

    <!-- Tween -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.1/TweenLite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.1/plugins/EaselPlugin.min.js"></script>
    <script src="OrangeTween.js"></script>  
    <script src="Puzzle.js"></script>  
    <script src="Resource.js"></script>      
    <script src="MainStage.js"></script>

	<script>
        var screenWidth = 480;
        var screenHeight = 640;

        // 舞台
        var stage;

        // 玩家數值
        // 下注單位
        var g_nBet = 0;
        // 下注線(PayLines)
        var g_nPayLines = 0;
    
 
        // 載入物件
        // var loadingImg;
        var loaderBar;
        var barShape; 
        var bar;   
        var barWidth;   

        // 背景顏色
        // var bg;

        // 遊戲大廳
        var lobbyContainer;
        // 遊戲畫面
        var gameContainer;
        // 滾輪
        // var slotRools;
        // 老虎機
        var slotMachine;
        // 贏錢線
        var g_PayLines;

        // 資源
        var assets;
        // 圖示資源(1~9)(10:WILD)(11:BONUS)(12:SCATTER)
        var iconAssets;


        // 緯經度
        var geoLocationText;
        // 方位
        var orientationText;
        // 拼圖距離
        var geoLocationDiffText;


        // 地圖背景圖
        var backgroundBitmap;

        var puzzle03Bitmap;

        var puzzleLine4x4Bitmap;

        // 玩家陣列
        var role;

        var myPuzzleContainer;

        // 地圖容器
        var mapContainer;

        // 拼圖容器(頂層)
        var topPuzzleContainer;

        // 拼圖容器(底層)
        var bottomPuzzleContainer;

        // 更新位置
        var captureButton;

        // 玩家名稱
        var username;

        // 目前的拼圖塊容器
        var currentPuzzleContainer;
        // 目前的拼圖塊
        var currentPuzzle; 
        // 目前的拼圖塊ID
        var currentPuzzleId = 0;

        // 拼圖資源
        var puzzleArray;

        var topNormalPuzzleArray;
        var topBlackPuzzleArray;


        // 問題容器
        var questonContainer;
        // 問題版
        var questionBoard;
        // 文字
        var questionText;
        // 圖片
        var questionImage;
        // 答案A
        var aAnswerButton;
        // 答案B
        var bAnswerButton;
        // 答案C
        var cAnswerButton;


        window.onload = function () 
        {
            console.log("init");
            init();
        };

        function watchDeviceOrientation()
        {
            if (window.DeviceOrientationEvent) 
            {
                window.addEventListener("deviceorientation", handleOrientation);
            } 
            else 
            {
                alert("無法進行遊戲，目前使用的瀏覽器不支援陀螺儀。");
            }
        }

        function handleOrientation(event) 
        {
             var absolute = event.absolute;
             var alpha    = event.alpha; // Z  0~360
             var beta     = event.beta;  
             var gamma    = event.gamma; 
            // Do stuff with the new orientation data

            // Because we don't want to have the device upside down
            // We constrain the x value to the range [-90,90]
            if (beta >  90) { beta =  90};
            if (beta < -90) { beta = -90};
            
            console.log("alpha = "+ alpha +" beta = "+beta);
            if(alpha != null)
            {
                 if(mapContainer != null)
                {
                    
                    // for(int i=0; i<16; i++)
                    // {
                       // var type = puzzleArray[0].getType(); 
                       // if(type == 0)
                       // {
                          // puzzleArray[0].regY -= beta;
                          // console.log("Y:"+puzzleArray[0].regY);

                          topPuzzleContainer.rotation = alpha;

                          // if(puzzleArray[0].regY <= 0)
                          // {

                          // }
                       // }
                    // }

                    // puzzleArray[0].regY += beta;
                }
                // puzzle03Bitmap.rotation = alpha;
                if(orientationText != null)
                {
                    orientationText.text = "方位："+alpha;
                }
            }
        }

        function formatFloat(num, pos)
        {
            var size = Math.pow(10, pos);
            return Math.round(num * size) / size;
        }        

        function getUserName()
        {
            var parameters = location.search.substring(1).split("&");
            if(parameters.length == 0)
            {
                username = "路人";
            }
            else
            {
                var temp = parameters[0].split("=");
                if(temp.length == 0)
                {
                    username = "路人";
                }
                else
                {
                    username = unescape(temp[1]);
                }
            }
            console.log(username);
            // temp = parameters[1].split("=");
            // p = unescape(temp[1]);
            // console.log(p);
        }

        //  註冊畫面大小改變
        window.addEventListener('resize', resize, false);
        function resize()
        {
            stage.canvas.width = window.innerWidth;                  
            stage.canvas.height = window.innerHeight; 

            var rate = stage.canvas.width / 480;
            stage.canvas.height = 960 * rate;

            stage.scaleX = stage.canvas.width / 480;
            stage.scaleY = stage.scaleX;            
        }

    	function init() 
        {
            // var screenOrientationPromise = screen.orientation.lock('portrait-primary');

            getUserName();

            // Image陣列物件
            assets = [];
            iconAssets = [];
            // 拼圖物件
            puzzleArray = [];

            topBlackPuzzleArray = [];
            topNormalPuzzleArray = [];

    		// Stage物件：Display List 最底層的物件
    		var canvas = document.getElementById("GameCanvas");

    		stage = new createjs.Stage(canvas); 
            // stageWidth = stage.canvas.width;
            // stageHeight = stage.canvas.height;        

  

            // 經典的你好世界
    		// var text = new createjs.Text("Hello World!", "36px Arial", "#777");
    		// stage.addChild(text);

            // 讀取進度條
            // =================================================================
            barWidth = 300;
            var barHeight = 20;
            // 外框距離
            var padding = 3;      

            // getRGB() 回傳字串  EX: "rgb(255, 255, 255)"        
            var loaderColor = createjs.Graphics.getRGB(247,247,247);

            // 畫框線
            bar = new createjs.Shape();
            bar.graphics.beginFill(loaderColor).drawRect(0, 0, 1, 20).endFill();        

            // 填滿顏色
            var bgBar = new createjs.Shape();
            bgBar.graphics.setStrokeStyle(1).beginStroke(loaderColor).drawRect(-padding/2, -padding/2, barWidth+padding, barHeight+padding);        

            loaderBar = new createjs.Container();
            loaderBar.x = (480 - barWidth)>>1;
            loaderBar.y = (480 - barHeight)>>1; 
            loaderBar.addChild(bar, bgBar);     
            // loaderBar.visible = false;

            stage.addChild(loaderBar);
            // =================================================================

            resize();
            // 開始讀取
            startLoading();       
            
            createjs.Ticker.timingMode = createjs.Ticker.RAF_SYNCHED;
            createjs.Ticker.setFPS(60);
            createjs.Ticker.addEventListener("tick", tickFunction);
            // createjs.Ticker.setPaused(true);
           
            // 監聽裝置方位
            watchDeviceOrientation();

    	}

        function mouseDownHandler(event)
        {
           console.log(nameInput.value);
        }

        function tickFunction() 
        {
            // if(!createjs.Ticker.getPaused())
            // {
                stage.update();
                // console.log("update");
            // }

            rollContainer(mapContainer, 0.15);
            rollContainer(bottomPuzzleContainer, -0.1);
            // rollContainer();
        }   

        function rollContainer(container, speed)
        {
            if(container != null)
            {    
                container.rotation +=speed;
                if(container.rotation>=360)
                {
                    container.rotation=0; 
                }
            }
        }

        // 丟入目前的拼圖塊
        function dropCurrentPuzzle(puzzleId)
        {
            console.log("丟拼圖塊:"+puzzleId);
            
            var i = 0;
            for(i = 0 ; i<puzzleArray.length; i++)
            {
                console.log("拼圖類別:"+i+" > "+puzzleArray[i].getType());
                if(puzzleArray[i].mType == 1)
                {
                    console.log("找尋目前拼圖:"+puzzleArray[i].getPuzzleId());
                    if(puzzleArray[i].mPuzzleId == puzzleId)
                    {
                        console.log("找到了");
                        puzzleArray[i].visible = true;
                        var tween = createjs.Tween.get(puzzleArray[i]) 
                        .to({scaleX: 3, scaleY: 3}, 0, createjs.Ease.bounceOut)
                        .to({scaleX: 1, scaleY: 1}, 2000, createjs.Ease.bounceOut); 
                        break;
                    }
                }
            }

       
        }

	</script>
</head>
	
<body>
    <div id="map"></div>
    <div class="canvasHolder">
        <canvas id="GameCanvas" width="480" height="640"></canvas> 
    </div>
</body>

</html>
