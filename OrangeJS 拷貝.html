<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=320; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
    <style type="text/css">

        /* Remove margins and HTML scrollbars */
        BODY, HTML  {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>  

	<title>SlotGame: EaselJS Version</title>

    <!-- 風格 -->
	<link href="GameStyles.css" rel="stylesheet" type="text/css" />

    <!-- CreateJS -->
	 <script type="text/javascript" src="https://code.createjs.com/createjs-2015.11.26.min.js"></script> 

    <!-- Tween -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.1/TweenLite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.1/plugins/EaselPlugin.min.js"></script>

    <script src="CanvasInput.js"></script>  

    <script src="Resource.js"></script>        
    <script src="MainStage.js"></script>          

	<script>
        var screenWidth = 480;
        var screenHeight = 640;
        // 距離（值越大 走的距離可以越短）
        var walkValue = 300000;

        var nameInput;

        function success(position) 
        {
            textGeoLocation.text = "位置："+position.coords.latitude+" x "+position.coords.longitude;
        }

        function error(msg) {
          // console.log(arguments);
        }

        window.onload = function () 
        {
            console.log("init");
            init();
        };

        function getCurrentLocation()
        {
            if (navigator.geolocation) 
            {
              navigator.geolocation.getCurrentPosition(success, error);
            } 
            else 
            {
              error('not supported');
            }
        }

        var geolocation=navigator.geolocation; //取得 Geolocation 物件
        function watchDeviceLocation()
        {
            if (navigator.geolocation) 
            {
                var timeoutVal = 10 * 1000 * 1000;
                var option =
                {
                    enableHighAccuracy:true,
                    maximumAge:1000, // 每次都取新的是0
                    timeout:60000
                };
                geolocation.watchPosition(
                    displayPosition, 
                    displayError,
                    option
                );
            }
            else 
            {
                alert("Geolocation is not supported by this browser");
            }
        }

        function watchDeviceOrientation()
        {
            if (window.DeviceOrientationEvent) 
            {
                window.addEventListener("deviceorientation", handleOrientation);
            } 
            else 
            {
                alert("Sorry, your browser doesn't support Device Orientation");
            }
        }

        function handleOrientation(event) 
        {
             var absolute = event.absolute;
             var alpha    = event.alpha; // Z  0~360
             var beta     = event.beta; 
             var gamma    = event.gamma;
            // Do stuff with the new orientation data
            
            console.log("alpha = "+alpha);
            if(alpha != null)
            {
                 if(mapConatainer != null)
                {
                    mapConatainer.rotation = alpha;
                }
                // myPuzzleContainer.position.x = stage.canvas.width/2;
                // myPuzzleContainer.position.y = stage.canvas.height/2-puzzle03Bitmap.height;
                // puzzle03Bitmap.rotation = alpha;
                if(orientationText != null)
                {
                    orientationText.text = "方位："+alpha;
                }
            }
        }

        function displayPosition(position) 
        {

            // Position 物件的屬性  說明 
            //  coords  Coordinates 座標物件, 存放傳回之位置資訊
            //  timestamp   取得位置資訊之時間 (毫秒, 自 1970/1/1 起)

            // Coordinates 物件的屬性   說明 
            //  latitude    緯度 (單位 degree)
            //  longitude   經度 (單位 degree)
            //  altitude    高度 (單位 meter), 若裝置不支援則傳回 0
            //  accuracy    位置誤差  (單位 meter)
            //  altitudeAccuracy    高度誤差 (單位 meter), 若裝置不支援則傳回 0
            //  heading     移動方向 (單位 degree)
            //  speed   移動速度 (單位 meter/second)


            geoLocationDiffText.text = "精確度:"+position.coords.accuracy;

            geoLocationText.text = position.coords.latitude+" x "+position.coords.longitude;

            // displayGooglePosition(position);


           // 對應座標點

                // 1. 取得自己的座標點
                // 2. 比對橘子園的座標點（25.028895, 121.514731）
                // 3. 計算出拼圖應該出現的位置

                // var diffLatitude = formatFloat((position.coords.latitude - 25.028895), 10) * walkValue;
                // var diffLongitude = formatFloat((position.coords.longitude - 121.514731), 8) * walkValue;


                var diffLatitude = (position.coords.latitude - 25.028895);
                var diffLongitude = (position.coords.longitude - 121.514731);

                // puzzleLine4x4Bitmap

                console.log("緯度差距："+diffLatitude+" x 經度差距："+diffLongitude);

                // geoLocationDiffText.text = "緯度差距："+diffLatitude+" x 經度差距："+diffLongitude;

                // var length = Math.sqrt((diffLatitude * diffLatitude) + (diffLongitude * diffLongitude));



            
                // 等於橘子園的座標
                // mapConatainer.x = (screenWidth)/2 + diffLatitude;
                // mapConatainer.y = (screenHeight)/2 + diffLongitude;

                // var x = Math.cos(mapConatainer.rotation);
                // var y = Math.sin(mapConatainer.rotation);



                // backgroundBitmap.regX = 480/2 + (x*length*10000);
                // backgroundBitmap.regY = 480/2 + (y*length*10000);


                // backgroundBitmap
        }    

        function formatFloat(num, pos)
        {
            var size = Math.pow(10, pos);
            return Math.round(num * size) / size;
        }

        function displayError(error) 
        {
            var errors = 
            { 
                1: 'Permission denied',
                2: 'Position unavailable',
                3: 'Request timeout'
            };
            alert("Error: " + errors[error.code]);
        }

        // function displayGooglePosition(position) 
        // {            
        //     var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        //     var options = {
        //         zoom: 10,
        //         center: pos,
        //         mapTypeId: google.maps.MapTypeId.ROADMAP
        //     };
        //     var map = new google.maps.Map(document.getElementById("map"), options);
        //     // Remove the current marker, if there is one
        //     if (typeof(marker) != "undefined") marker.setMap(null);
        //     marker = new google.maps.Marker({
        //         position: pos,
        //         map: map,
        //         title: "User location"
        //     });
        //     var contentString = "<b>Timestamp:</b> " + parseTimestamp(position.timestamp) + "<br/><b>User location:</b> lat " + position.coords.latitude + ", long " + position.coords.longitude + ", accuracy " + position.coords.accuracy;
        //     // Remove the current infoWindow, if there is one
        //     if (typeof(infoWindow) != "undefined") infoWindow.setMap(null);
        //     infowindow = new google.maps.InfoWindow({
        //         content: contentString
        //     });
        //     google.maps.event.addListener(marker, 'click', function() {
        //         infowindow.open(map,marker);
        //     });
        // }        

        // 舞台
        var stage;


        // 玩家數值
        // 下注單位
        var g_nBet = 0;
        // 下注線(PayLines)
        var g_nPayLines = 0;
    
 
        // 載入物件
        // var loadingImg;
        var loaderBar;
        var barShape; 
        var bar;   
        var barWidth;   

        // 背景顏色
        // var bg;

        // 遊戲大廳
        var lobbyContainer;
        // 遊戲畫面
        var gameContainer;
        // 滾輪
        // var slotRools;
        // 老虎機
        var slotMachine;
        // 贏錢線
        var g_PayLines;

        // 資源
        var assets;
        // 圖示資源(1~9)(10:WILD)(11:BONUS)(12:SCATTER)
        var iconAssets;


        // 緯經度
        var geoLocationText;
        // 方位
        var orientationText;
        // 拼圖距離
        var geoLocationDiffText;


        // 地圖背景圖
        var backgroundBitmap;

        var puzzle03Bitmap;

        var puzzleLine4x4Bitmap;

        // 玩家陣列
        var role;

        var myPuzzleContainer;

        // 地圖容器
        var mapContainer;

        // 拼圖容器
        var puzzleContainer;

        // 更新位置
        var updateLocationButton;

        // 玩家名稱
        var username;

        function getUserName()
        {
            var parameters = location.search.substring(1).split("&");
            if(parameters.length == 0)
            {
                username = "路人";
            }
            else
            {
                var temp = parameters[0].split("=");
                if(temp.length == 0)
                {
                    username = "路人";
                }
                else
                {
                    username = unescape(temp[1]);
                }
            }
            console.log(username);
            // temp = parameters[1].split("=");
            // p = unescape(temp[1]);
            // console.log(p);
        }

        //  註冊畫面大小改變
        window.addEventListener('resize', resize, false);
        function resize()
        {
            stage.canvas.width = window.innerWidth;                  
            stage.canvas.height = window.innerHeight; 

            var rate = stage.canvas.width / 480;
            stage.canvas.height = 960 * rate;

            stage.scaleX = stage.canvas.width / 480;
            stage.scaleY = stage.scaleX;            
        }

    	function init() 
        {
            getUserName();

            // Image陣列物件
            assets = [];
            iconAssets = []

    		// Stage物件：Display List 最底層的物件
    		var canvas = document.getElementById("GameCanvas");

    		stage = new createjs.Stage(canvas); 
            // stageWidth = stage.canvas.width;
            // stageHeight = stage.canvas.height;        

            // 滾輪物件
            slotRools = []

            // 經典的你好世界
    		// var text = new createjs.Text("Hello World!", "36px Arial", "#777");
    		// stage.addChild(text);

            // 讀取進度條
            // =================================================================
            barWidth = 300;
            var barHeight = 20;
            // 外框距離
            var padding = 3        

            // getRGB() 回傳字串  EX: "rgb(255, 255, 255)"        
            var loaderColor = createjs.Graphics.getRGB(247,247,247);

            // 畫框線
            bar = new createjs.Shape();
            bar.graphics.beginFill(loaderColor).drawRect(0, 0, 1, 20).endFill();        

            // 填滿顏色
            var bgBar = new createjs.Shape();
            bgBar.graphics.setStrokeStyle(1).beginStroke(loaderColor).drawRect(-padding/2, -padding/2, barWidth+padding, barHeight+padding);        

            loaderBar = new createjs.Container();
            loaderBar.x = (480 - barWidth)>>1;
            loaderBar.y = (480 - barHeight)>>1; 
            loaderBar.addChild(bar, bgBar);     
            // loaderBar.visible = false;

            stage.addChild(loaderBar);
            // =================================================================


           

            resize();



            // 開始讀取
            startLoading();       
            
            createjs.Ticker.timingMode = createjs.Ticker.RAF_SYNCHED;
            createjs.Ticker.setFPS(60);
            createjs.Ticker.addEventListener("tick", tickFunction);
            createjs.Ticker.setPaused(true);
           

        
            // 監聽裝置方位
            watchDeviceOrientation();

    	}


        function addUserName()
        {

        }


        function mouseDownHandler(event)
        {
           console.log(nameInput.value);
        }

        function addNameInput()
        {
            var gameCanvas = document.getElementById('GameCanvas');

            //加入事件偵聽
            gameCanvas.addEventListener('mousedown', mouseDownHandler, false);            


            nameInput = new CanvasInput(
            {
              canvas: gameCanvas,
              x:(screenWidth-300)/2,
              y:100,
              fontSize: 18,
              fontFamily: 'Arial',
              fontColor: '#212121',
              fontWeight: 'bold',
              width: 300,
              padding: 8,
              borderWidth: 1,
              borderColor: '#000',
              borderRadius: 3,
              boxShadow: '1px 1px 0px #fff',
              innerShadow: '0px 0px 5px rgba(0, 0, 0, 0.5)',
              placeHolder: '請輸入您的名字...'
            });

            var ctx = gameCanvas.getContext("2d");
            ctx.font = "30px Arial";
            ctx.fillText("超級旋轉問答",screenWidth/2-75,100-30);

            ctx.font = "11px Arial";
            ctx.fillStyle = "#FFFFFF";
            ctx.fillText("(C) GEOTHINGS TAIWAN CO.,LTD 2016",screenWidth/2-99,screenWidth-33);
        }

        function tickFunction() 
        {
            // if(!createjs.Ticker.getPaused())
            // {
                stage.update();
                // console.log("update");
            // }
            // getCurrentLocation();

            puzzleContainer.rotation +=0.2;
            if(puzzleContainer.rotation>=360)
            {
               puzzleContainer.rotation=0; 
            }
        }           

	</script>
</head>
	
<body>
    <div id="map"></div>
    <div class="canvasHolder">
        <canvas id="GameCanvas" width="480" height="640"></canvas> 
    </div>
</body>

</html>
